generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model market_events {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type       String   @db.VarChar(20)
  starts_at  DateTime @db.Timestamptz(6)
  ends_at    DateTime @db.Timestamptz(6)
  payload    Json     @default("{}")
  is_active  Boolean  @default(true)
  created_at DateTime @default(now()) @db.Timestamptz(6)

  @@index([is_active], map: "idx_market_events_active")
  @@index([ends_at], map: "idx_market_events_ends_at")
  @@index([payload], map: "idx_market_events_payload", type: Gin)
  @@index([starts_at], map: "idx_market_events_starts_at")
  @@index([type], map: "idx_market_events_type")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model order_items {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id           String   @db.Uuid
  product_id         String   @db.Uuid
  qty                Int
  locked_price_cents Int
  line_total_cents   Int
  created_at         DateTime @default(now()) @db.Timestamptz(6)
  orders             orders   @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products           products @relation(fields: [product_id], references: [id], onUpdate: NoAction)

  @@index([order_id], map: "idx_order_items_order_id")
  @@index([product_id], map: "idx_order_items_product_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model orders {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id   String?        @db.Uuid
  status       String         @default("PENDING") @db.VarChar(20)
  kds_status   String?        @default("QUEUED") @db.VarChar(20) // Status operacional da fila
  total_cents  Int            @default(0)
  currency     String         @default("BRL") @db.VarChar(3)
  note         String?        @db.Text // Observação do pedido
  created_at   DateTime       @default(now()) @db.Timestamptz(6)
  confirmed_at DateTime?      @db.Timestamptz(6)
  canceled_at  DateTime?      @db.Timestamptz(6)
  updated_at   DateTime       @default(now()) @db.Timestamptz(6)
  order_items  order_items[]
  sessions     sessions?      @relation(fields: [session_id], references: [id], onUpdate: NoAction)
  price_locks  price_locks[]
  trade_events trade_events[]

  @@index([created_at(sort: Desc)], map: "idx_orders_created_at")
  @@index([session_id], map: "idx_orders_session_id")
  @@index([session_id, status], map: "idx_orders_session_status")
  @@index([status], map: "idx_orders_status")
  @@index([kds_status], map: "idx_orders_kds_status")
  @@index([confirmed_at], map: "idx_orders_confirmed_at")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model price_history {
  id          BigInt   @id @default(autoincrement())
  product_id  String   @db.Uuid
  price_cents Int
  tick_seq    BigInt
  recorded_at DateTime @default(now()) @db.Timestamptz(6)
  products    products @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([product_id], map: "idx_price_history_product_id")
  @@index([product_id, recorded_at(sort: Desc)], map: "idx_price_history_product_recorded")
  @@index([recorded_at], map: "idx_price_history_recorded_at")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model price_locks {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id           String    @db.Uuid
  product_id         String    @db.Uuid
  qty                Int
  locked_price_cents Int
  expires_at         DateTime  @db.Timestamptz(6)
  status             String    @default("ACTIVE") @db.VarChar(20)
  created_at         DateTime  @default(now()) @db.Timestamptz(6)
  used_at            DateTime? @db.Timestamptz(6)
  orders             orders    @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products           products  @relation(fields: [product_id], references: [id], onUpdate: NoAction)

  @@index([expires_at], map: "idx_price_locks_expires_at")
  @@index([order_id], map: "idx_price_locks_order_id")
  @@index([product_id], map: "idx_price_locks_product_id")
  @@index([status], map: "idx_price_locks_status")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model price_states {
  product_id       String   @id @db.Uuid
  price_cents      Int
  prev_price_cents Int
  tick_seq         BigInt   @default(0)
  updated_at       DateTime @default(now()) @db.Timestamptz(6)
  products         products @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tick_seq], map: "idx_price_states_tick_seq")
  @@index([updated_at], map: "idx_price_states_updated_at")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model products {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sku               String          @unique @db.VarChar(100)
  ticker            String          @unique @db.VarChar(7)
  ticker_source     String          @db.VarChar(10)
  name              String          @db.VarChar(255)
  description       String?
  category          String          @db.VarChar(100)
  is_active         Boolean         @default(true)
  base_price_cents  Int
  price_floor_cents Int
  price_cap_cents   Int
  created_at        DateTime        @default(now()) @db.Timestamptz(6)
  updated_at        DateTime        @default(now()) @db.Timestamptz(6)
  order_items       order_items[]
  price_history     price_history[]
  price_locks       price_locks[]
  price_states      price_states?
  trade_events      trade_events[]

  @@index([category], map: "idx_products_category")
  @@index([is_active], map: "idx_products_is_active")
  @@index([sku], map: "idx_products_sku")
  @@index([ticker], map: "idx_products_ticker")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model sessions {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  table_id  String?   @db.Uuid
  status    String    @default("ACTIVE") @db.VarChar(20)
  opened_at DateTime  @default(now()) @db.Timestamptz(6)
  closed_at DateTime? @db.Timestamptz(6)
  orders    orders[]
  tables    tables?   @relation(fields: [table_id], references: [id], onUpdate: NoAction)

  @@index([opened_at(sort: Desc)], map: "idx_sessions_opened_at")
  @@index([status], map: "idx_sessions_status")
  @@index([table_id], map: "idx_sessions_table_id")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model tables {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code       String     @unique @db.VarChar(20)
  is_active  Boolean    @default(true)
  created_at DateTime   @default(now()) @db.Timestamptz(6)
  sessions   sessions[]

  @@index([code], map: "idx_tables_code")
  @@index([is_active], map: "idx_tables_is_active")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model trade_events {
  id          BigInt   @id @default(autoincrement())
  product_id  String   @db.Uuid
  order_id    String?  @db.Uuid
  qty         Int
  price_cents Int
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  orders      orders?  @relation(fields: [order_id], references: [id], onUpdate: NoAction)
  products    products @relation(fields: [product_id], references: [id], onUpdate: NoAction)

  @@index([created_at(sort: Desc)], map: "idx_trade_events_created_at")
  @@index([order_id], map: "idx_trade_events_order_id")
  @@index([product_id, created_at(sort: Desc)], map: "idx_trade_events_product_created")
  @@index([product_id], map: "idx_trade_events_product_id")
}
